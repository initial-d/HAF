# HAF Test Suite Documentation

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ç›®çš„ã€æµ‹è¯•å†…å®¹å’Œé¢„æœŸç»“æœã€‚

## æµ‹è¯•æ¦‚è§ˆ

- **æ€»æµ‹è¯•æ•°**: 17ä¸ª
- **æµ‹è¯•ç±»åˆ«**: 4ä¸ªï¼ˆGaussianDistribution, CredalSet, HAF, Integrationï¼‰
- **ä»£ç è¦†ç›–**: æ ¸å¿ƒç®—æ³•çš„å…³é”®è·¯å¾„
- **è¿è¡Œæ—¶é—´**: ~2-3ç§’

---

## 1. TestGaussianDistribution (3ä¸ªæµ‹è¯•)

æµ‹è¯•å•ä¸ªé«˜æ–¯åˆ†å¸ƒçš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿™æ˜¯Credalé›†åˆçš„åŸºæœ¬æ„å»ºå—ã€‚

### 1.1 `test_initialization`

**æµ‹è¯•å†…å®¹**: éªŒè¯é«˜æ–¯åˆ†å¸ƒèƒ½å¦æ­£ç¡®åˆå§‹åŒ–

**ä¸ºä»€ä¹ˆæµ‹è¯•**: 
- ç¡®ä¿å‡å€¼å‘é‡å’Œåæ–¹å·®çŸ©é˜µè¢«æ­£ç¡®å­˜å‚¨
- é˜²æ­¢æµ…æ‹·è´å¯¼è‡´çš„æ„å¤–ä¿®æ”¹
- è¿™æ˜¯æ‰€æœ‰åç»­æ“ä½œçš„åŸºç¡€

**æµ‹è¯•æ­¥éª¤**:
```python
mu = [0.0, 0.0]
sigma = [[0.01, 0], [0, 0.01]]
dist = GaussianDistribution(mu, sigma)
```

**é¢„æœŸç»“æœ**: 
- `dist.mu` åº”ç­‰äºè¾“å…¥çš„å‡å€¼
- `dist.sigma` åº”ç­‰äºè¾“å…¥çš„åæ–¹å·®
- ä½¿ç”¨`np.allclose()`å¤„ç†æµ®ç‚¹æ•°ç²¾åº¦

---

### 1.2 `test_likelihood`

**æµ‹è¯•å†…å®¹**: éªŒè¯ä¼¼ç„¶å‡½æ•°è®¡ç®—æ˜¯å¦æ­£ç¡®

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- ä¼¼ç„¶å‡½æ•°ç”¨äºBayesianæ›´æ–°
- å¿…é¡»æ»¡è¶³æ¦‚ç‡å¯†åº¦å‡½æ•°çš„åŸºæœ¬æ€§è´¨
- å‡å€¼å¤„çš„ä¼¼ç„¶åº”è¯¥æœ€å¤§

**æµ‹è¯•æ­¥éª¤**:
```python
dist = N(Î¼=0, ÏƒÂ²=1)
lik_at_mean = dist.likelihood(x=0)    # åœ¨å‡å€¼å¤„
lik_away = dist.likelihood(x=2)        # åç¦»å‡å€¼
```

**é¢„æœŸç»“æœ**: 
- `lik_at_mean > lik_away` ï¼ˆå‡å€¼å¤„æ¦‚ç‡å¯†åº¦æœ€å¤§ï¼‰
- ä½¿ç”¨scipyçš„`multivariate_normal.pdf()`ç¡®ä¿æ­£ç¡®æ€§

---

### 1.3 `test_bayesian_update`

**æµ‹è¯•å†…å®¹**: éªŒè¯Bayesianå‚æ•°æ›´æ–°çš„æ­£ç¡®æ€§

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- è¿™æ˜¯HAFç®—æ³•çš„æ ¸å¿ƒæ“ä½œï¼ˆè®ºæ–‡å…¬å¼14-15ï¼‰
- å¿…é¡»æ»¡è¶³Bayesianæ¨æ–­çš„æ•°å­¦æ€§è´¨
- æ›´æ–°åçš„åˆ†å¸ƒåº”è¯¥å‘è§‚æµ‹å€¼ç§»åŠ¨

**æµ‹è¯•æ­¥éª¤**:
```python
prior = N(Î¼=0, ÏƒÂ²=1)
observation = 1.0
posterior = prior.bayesian_update(obs, noise)
```

**é¢„æœŸç»“æœ**: 
- **å‡å€¼**: `0 < posterior.Î¼ < 1` ï¼ˆåœ¨å…ˆéªŒå’Œè§‚æµ‹ä¹‹é—´ï¼‰
- **æ–¹å·®**: `posterior.ÏƒÂ² < prior.ÏƒÂ²` ï¼ˆä¿¡æ¯å¢åŠ ï¼Œä¸ç¡®å®šæ€§ä¸‹é™ï¼‰
- ç¬¦åˆKalmanæ»¤æ³¢çš„æ›´æ–°è§„åˆ™

**æ•°å­¦åŸç†**:
```
Î£_new^{-1} = Î£_prior^{-1} + Î£_noise^{-1}
Î¼_new = Î£_new * (Î£_prior^{-1} * Î¼_prior + Î£_noise^{-1} * x)
```

---

## 2. TestCredalSet (5ä¸ªæµ‹è¯•)

æµ‹è¯•Credalé›†åˆçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬è·ç¦»åº¦é‡å’Œæ›´æ–°æœºåˆ¶ã€‚

### 2.1 `test_initialization`

**æµ‹è¯•å†…å®¹**: éªŒè¯Credalé›†åˆçš„åˆå§‹åŒ–

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- ç¡®ä¿Kä¸ªæç«¯åˆ†å¸ƒè¢«æ­£ç¡®å­˜å‚¨
- éªŒè¯æ·±æ‹·è´æœºåˆ¶ï¼ˆé¿å…å¼•ç”¨é—®é¢˜ï¼‰
- æ£€æŸ¥åŸºæœ¬å±æ€§ï¼ˆKå€¼ï¼‰

**æµ‹è¯•æ­¥éª¤**:
```python
d1 = GaussianDistribution(Î¼=0, Ïƒ=1)
d2 = GaussianDistribution(Î¼=1, Ïƒ=1)
credal_set = CredalSet([d1, d2])
```

**é¢„æœŸç»“æœ**:
- `credal_set.K == 2`
- `len(credal_set.extremes) == 2`
- ä¿®æ”¹åŸå§‹d1ä¸å½±å“credal_setä¸­çš„åˆ†å¸ƒ

---

### 2.2 `test_wasserstein_distance`

**æµ‹è¯•å†…å®¹**: éªŒè¯Wasserstein-2è·ç¦»è®¡ç®—

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- Wasserstein-2æ˜¯HAFä½¿ç”¨çš„æ ¸å¿ƒåº¦é‡ï¼ˆè®ºæ–‡å…¬å¼17ï¼‰
- å¿…é¡»æ»¡è¶³åº¦é‡ç©ºé—´çš„å…¬ç†
- å¯¹äºé«˜æ–¯åˆ†å¸ƒæœ‰é—­å¼è§£ï¼Œå¯ä»¥éªŒè¯æ­£ç¡®æ€§

**æµ‹è¯•æ­¥éª¤**:
```python
dist = wasserstein2_distance(N(0,1), N(1,1))
dist_self = wasserstein2_distance(N(0,1), N(0,1))
```

**é¢„æœŸç»“æœ**:
- `dist > 0` ï¼ˆæ­£å®šæ€§ï¼‰
- `dist_self â‰ˆ 0` ï¼ˆè‡ªèº«è·ç¦»ä¸º0ï¼‰
- å¯¹äº1ç»´é«˜æ–¯: `Wâ‚‚(N(Î¼â‚,Ïƒâ‚), N(Î¼â‚‚,Ïƒâ‚‚)) = âˆš((Î¼â‚-Î¼â‚‚)Â² + (Ïƒâ‚-Ïƒâ‚‚)Â²)`

**æ•°å­¦èƒŒæ™¯**: Wasserstein-2è·ç¦»è¡¡é‡ä¸¤ä¸ªåˆ†å¸ƒä¹‹é—´çš„"æœ€ä¼˜è¿è¾“æˆæœ¬"

---

### 2.3 `test_hausdorff_distance`

**æµ‹è¯•å†…å®¹**: éªŒè¯Credalé›†åˆä¹‹é—´çš„Hausdorffè·ç¦»

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- Hausdorffåº¦é‡æ˜¯HAF regimeæ£€æµ‹çš„å…³é”®ï¼ˆè®ºæ–‡å…¬å¼4ï¼‰
- å¿…é¡»æ»¡è¶³å¯¹ç§°æ€§å’Œæ­£å®šæ€§
- ç”¨äºè®¡ç®—æ”¶ç¼©ç‡Ï

**æµ‹è¯•æ­¥éª¤**:
```python
cs1 = CredalSet([N(0,1)])
cs2 = CredalSet([N(1,1)])
d_H = cs1.hausdorff_distance(cs2)
d_H_reverse = cs2.hausdorff_distance(cs1)
```

**é¢„æœŸç»“æœ**:
- `d_H > 0` ï¼ˆéé›¶è·ç¦»ï¼‰
- `d_H â‰ˆ d_H_reverse` ï¼ˆå¯¹ç§°æ€§ï¼Œè¯¯å·®<0.001%ï¼‰

**æ•°å­¦å®šä¹‰**:
```
d_H(P,Q) = max(sup_{PâˆˆP} inf_{QâˆˆQ} d(P,Q), sup_{QâˆˆQ} inf_{PâˆˆP} d(P,Q))
```

---

### 2.4 `test_diameter`

**æµ‹è¯•å†…å®¹**: éªŒè¯Credalé›†åˆç›´å¾„è®¡ç®—

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- ç›´å¾„quantifyè®¤çŸ¥ä¸ç¡®å®šæ€§ï¼ˆepistemic uncertaintyï¼‰
- HAFæ ¹æ®ç›´å¾„è°ƒæ•´ä»“ä½å¤§å°
- ç›´å¾„è¶Šå¤§ â†’ ä¸ç¡®å®šæ€§è¶Šé«˜ â†’ ä»“ä½è¶Šå°

**æµ‹è¯•æ­¥éª¤**:
```python
credal_set = CredalSet([N(0,1), N(2,1)])  # ç›¸éš”è¾ƒè¿œ
diam = credal_set.diameter()
```

**é¢„æœŸç»“æœ**:
- `diam > 0` ï¼ˆéç©ºé›†åˆå¿…æœ‰æ­£ç›´å¾„ï¼‰
- `diam = max_{i,j} d(P_i, P_j)` ï¼ˆæç«¯åˆ†å¸ƒé—´æœ€å¤§è·ç¦»ï¼‰

**åº”ç”¨æ„ä¹‰**: å½“å¸‚åœºregimeä¸æ˜ç¡®æ—¶ï¼Œcredal setä¼š"è†¨èƒ€"ï¼Œç›´å¾„å¢å¤§ï¼ŒHAFè‡ªåŠ¨å‡å°ä»“ä½

---

### 2.5 `test_bayesian_update`

**æµ‹è¯•å†…å®¹**: éªŒè¯Credalé›†åˆçš„æ•´ä½“æ›´æ–°

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- è¿™æ˜¯HAFæ¯æ­¥æ‰§è¡Œçš„æ ¸å¿ƒæ“ä½œ
- æ‰€æœ‰Kä¸ªæç«¯åˆ†å¸ƒå¿…é¡»åŒæ­¥æ›´æ–°
- æ›´æ–°ååº”ä¿æŒå‡¸åŒ…ç»“æ„

**æµ‹è¯•æ­¥éª¤**:
```python
cs = CredalSet([N(0,1), N(1,1)])
observation = 0.5
cs_updated = cs.bayesian_update(obs, noise)
```

**é¢„æœŸç»“æœ**:
- æç«¯åˆ†å¸ƒæ•°é‡ä¸å˜: `cs_updated.K == cs.K`
- æ¯ä¸ªåˆ†å¸ƒéƒ½å‘è§‚æµ‹å€¼ç§»åŠ¨:
  - `cs_updated.extremes[0].Î¼ > 0` ï¼ˆä»0å‘0.5ç§»åŠ¨ï¼‰
  - `cs_updated.extremes[1].Î¼ < 1` ï¼ˆä»1å‘0.5ç§»åŠ¨ï¼‰

**ç†è®ºæ„ä¹‰**: ä½“ç°è®ºæ–‡å®šç†4.1çš„æ”¶ç¼©æ€§è´¨

---

## 3. TestHAF (8ä¸ªæµ‹è¯•)

æµ‹è¯•HAFç®—æ³•çš„å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬regimeæ£€æµ‹å’Œå†³ç­–åˆ¶å®šã€‚

### 3.1 `test_initialization`

**æµ‹è¯•å†…å®¹**: éªŒè¯HAFæ­£ç¡®åˆå§‹åŒ–

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- ç¡®ä¿é»˜è®¤å‚æ•°è®¾ç½®æ­£ç¡®
- éªŒè¯3ä¸ªregimeï¼ˆbull/bear/neutralï¼‰è¢«åˆ›å»º
- æ£€æŸ¥å†å²è®°å½•æ•°ç»„åˆå§‹åŒ–

**æµ‹è¯•æ­¥éª¤**:
```python
haf = HausdorffAdaptiveFilter(n_assets=1)
```

**é¢„æœŸç»“æœ**:
- `haf.n_assets == 1`
- `haf.credal_set.K == 3` ï¼ˆ3ä¸ªæç«¯åˆ†å¸ƒï¼‰
- `haf.distances == []` ï¼ˆç©ºå†å²ï¼‰
- `haf.rho_history == []` ï¼ˆç©ºå†å²ï¼‰

**åˆå§‹Credalé›†åˆ**:
- Bull: Î¼=+0.001, ÏƒÂ²=0.0001 ï¼ˆæ­£æ”¶ç›Šï¼Œä½æ³¢åŠ¨ï¼‰
- Bear: Î¼=-0.002, ÏƒÂ²=0.0009 ï¼ˆè´Ÿæ”¶ç›Šï¼Œé«˜æ³¢åŠ¨ï¼‰
- Neutral: Î¼=0, ÏƒÂ²=0.0004 ï¼ˆé›¶æ”¶ç›Šï¼Œä¸­ç­‰æ³¢åŠ¨ï¼‰

---

### 3.2 `test_update_single_observation`

**æµ‹è¯•å†…å®¹**: éªŒè¯å•æ¬¡è§‚æµ‹æ›´æ–°

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- è¿™æ˜¯æœ€åŸºæœ¬çš„æ“ä½œ
- å¿…é¡»è¿”å›æœ‰æ•ˆçš„regimeå’Œposition_scale
- å¿…é¡»è®°å½•è·ç¦»å†å²

**æµ‹è¯•æ­¥éª¤**:
```python
haf = HausdorffAdaptiveFilter(n_assets=1)
regime, scale = haf.update(observation)
```

**é¢„æœŸç»“æœ**:
- `regime âˆˆ {'stable', 'uncertain', 'shift'}` ï¼ˆ3ç§æœ‰æ•ˆregimeï¼‰
- `0 < scale â‰¤ 1.0` ï¼ˆä»“ä½ç¼©æ”¾åœ¨åˆç†èŒƒå›´ï¼‰
- `len(haf.distances) == 1` ï¼ˆè®°å½•äº†1æ¬¡è·ç¦»ï¼‰
- `haf.distances[0] â‰¥ 0` ï¼ˆè·ç¦»éè´Ÿï¼‰

---

### 3.3 `test_update_sequence`

**æµ‹è¯•å†…å®¹**: éªŒè¯å¤šæ­¥æ›´æ–°åºåˆ—

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- çœŸå®åº”ç”¨ä¸­æ˜¯è¿ç»­æ›´æ–°
- éªŒè¯å†å²è®°å½•æ­£ç¡®ç§¯ç´¯
- æ£€æŸ¥æ”¶ç¼©ç‡è®¡ç®—ä½•æ—¶å¼€å§‹

**æµ‹è¯•æ­¥éª¤**:
```python
for t in range(20):
    haf.update(random_observation)
```

**é¢„æœŸç»“æœ**:
- `len(haf.distances) == 20` ï¼ˆæ¯æ­¥è®°å½•è·ç¦»ï¼‰
- `len(haf.rho_history) â‰¥ 18` ï¼ˆä»ç¬¬3æ­¥å¼€å§‹è®¡ç®—Ïï¼‰
- æ— å´©æºƒï¼Œæ— NaNå€¼

**ä¸ºä½•Ïä»ç¬¬3æ­¥å¼€å§‹**: 
```
Ï_t = d_H(P_t, P_{t-1}) / d_H(P_{t-1}, P_{t-2})
```
éœ€è¦è‡³å°‘3ä¸ªæ—¶åˆ»çš„æ•°æ®

---

### 3.4 `test_regime_detection_stable`

**æµ‹è¯•å†…å®¹**: éªŒè¯åœ¨ç¨³å®šæ•°æ®ä¸‹çš„è¡Œä¸º

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- ç¨³å®šregimeä¸‹ä¸åº”é¢‘ç¹è§¦å‘shift
- éªŒè¯å®šç†4.1çš„æ”¶æ•›æ€§è´¨
- é˜²æ­¢è¿‡åº¦æ•æ„Ÿï¼ˆfalse positiveï¼‰

**æµ‹è¯•æ­¥éª¤**:
```python
# ç”Ÿæˆ100ä¸ªæ¥è‡ªåŒä¸€åˆ†å¸ƒçš„è§‚æµ‹
for _ in range(100):
    obs = N(0.001, 0.01)
    haf.update(obs)
```

**é¢„æœŸç»“æœ**:
- æœ€å20æ­¥ä¸­ï¼Œshiftæ£€æµ‹ < 10æ¬¡ ï¼ˆ< 50%ï¼‰
- ç›´å¾„åº”è¯¥æ”¶æ•›ï¼ˆä¸æŒç»­å¢é•¿ï¼‰
- å¹³å‡æ”¶ç¼©ç‡ `E[Ï] < 1.5`

**ç†è®ºä¾æ®**: è®ºæ–‡å®šç†4.1è¯´æ˜åœ¨ç¨³å®šregimeä¸‹ï¼Œcredal setä»¥å‡ ä½•é€Ÿç‡æ”¶æ•›åˆ°å›ºå®šç‚¹

**ä¸ºä½•å…è®¸ä¸€äº›shift**: 
- å°æ ·æœ¬å™ªå£°å¯èƒ½å¯¼è‡´å¶å°”è¯¯æŠ¥
- è¿™åœ¨å®é™…åº”ç”¨ä¸­æ˜¯å¯æ¥å—çš„
- å…³é”®æ˜¯ä¸è¦**æŒç»­**è¯¯æŠ¥

---

### 3.5 `test_regime_detection_shift`

**æµ‹è¯•å†…å®¹**: éªŒè¯èƒ½å¤Ÿæ£€æµ‹åˆ°çœŸå®çš„regimeåˆ‡æ¢

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- è¿™æ˜¯HAFçš„æ ¸å¿ƒä»·å€¼ï¼šæ—©æœŸæ£€æµ‹regimeå˜åŒ–
- éªŒè¯å®šç†4.2çš„æ£€æµ‹èƒ½åŠ›
- ç¡®ä¿ä¸ä¼šæ¼æŠ¥ï¼ˆfalse negativeï¼‰

**æµ‹è¯•æ­¥éª¤**:
```python
# å‰30æ­¥ï¼šç¨³å®šæ•°æ® N(0.001, 0.01)
for _ in range(30):
    haf.update(stable_obs)

# å20æ­¥ï¼šå±æœºæ•°æ® N(-0.015, 0.03)
shift_detected = False
for _ in range(20):
    regime, _ = haf.update(crisis_obs)
    if regime == 'shift':
        shift_detected = True
```

**é¢„æœŸç»“æœ**:
- `shift_detected == True` ï¼ˆå¿…é¡»æ£€æµ‹åˆ°ï¼‰
- é€šå¸¸åœ¨3-5æ­¥å†…æ£€æµ‹åˆ°ï¼ˆå¯¹åº”è®ºæ–‡çš„1-3å‘¨ï¼‰

**æ•°å­¦åŸç†**: 
- åˆ‡æ¢å‰: Ï â‰ˆ Ï„ < 1 ï¼ˆæ”¶ç¼©ï¼‰
- åˆ‡æ¢å: Ï â‰« 1 ï¼ˆæ‰©å¼ ï¼‰
- å½“Ï > Ï_resetæ—¶è§¦å‘æ£€æµ‹

---

### 3.6 `test_get_action`

**æµ‹è¯•å†…å®¹**: éªŒè¯æ‚²è§‚å†³ç­–è§„åˆ™

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- è¿™æ˜¯HAFçš„è¾“å‡ºï¼športfolioæƒé‡
- å¿…é¡»è¿”å›æœ‰æ•ˆçš„æ•°å€¼ï¼ˆéNaNï¼‰
- éªŒè¯è®ºæ–‡å®šä¹‰4.2çš„å®ç°

**æµ‹è¯•æ­¥éª¤**:
```python
# æ›´æ–°ä¸€äº›æ•°æ®å
for _ in range(10):
    haf.update(obs)

action = haf.get_action()
```

**é¢„æœŸç»“æœ**:
- `action.shape == (n_assets,)` ï¼ˆæ­£ç¡®ç»´åº¦ï¼‰
- `not np.isnan(action)` ï¼ˆæ— éæ³•å€¼ï¼‰
- æƒé‡ä¹‹å’Œ â‰ˆ 1ï¼ˆå½’ä¸€åŒ–ï¼‰

**æ‚²è§‚è§„åˆ™**:
```python
action = argmax_a min_{Pâˆˆcredal_set} E_P[utility(a)]
```
é€‰æ‹©åœ¨æœ€åæƒ…å†µä¸‹ä»ç„¶æœ€ä¼˜çš„è¡ŒåŠ¨

---

### 3.7 `test_get_metrics`

**æµ‹è¯•å†…å®¹**: éªŒè¯ç›‘æ§æŒ‡æ ‡çš„è¾“å‡º

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- è¿™äº›æŒ‡æ ‡ç”¨äºå®æ—¶ç›‘æ§å’Œè°ƒè¯•
- å¿…é¡»åŒ…å«æ‰€æœ‰å…³é”®ä¿¡æ¯
- å€¼å¿…é¡»åœ¨åˆç†èŒƒå›´å†…

**æµ‹è¯•æ­¥éª¤**:
```python
haf.update(obs)
metrics = haf.get_metrics()
```

**é¢„æœŸç»“æœ**:
- åŒ…å«4ä¸ªé”®: `diameter`, `rho`, `distance`, `regime`
- `diameter â‰¥ 0` ï¼ˆéè´Ÿï¼‰
- `distance â‰¥ 0` ï¼ˆéè´Ÿï¼‰
- `regime âˆˆ {0, 1, 2}` ï¼ˆæ•´æ•°ç¼–ç ï¼‰

**æŒ‡æ ‡å«ä¹‰**:
- **diameter**: è®¤çŸ¥ä¸ç¡®å®šæ€§ï¼ˆè¶Šå¤§è¶Šä¸ç¡®å®šï¼‰
- **rho**: æ”¶ç¼©ç‡ï¼ˆ>1è¡¨ç¤ºæ‰©å¼ ï¼Œregimeå¯èƒ½åˆ‡æ¢ï¼‰
- **distance**: å½“å‰Hausdorffè·ç¦»
- **regime**: 0=stable, 1=uncertain, 2=shift

---

### 3.8 `test_reset_credal_set`

**æµ‹è¯•å†…å®¹**: éªŒè¯Credalé›†åˆé‡ç½®åŠŸèƒ½

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- æ£€æµ‹åˆ°regime shiftåéœ€è¦é‡ç½®å…ˆéªŒ
- é‡ç½®åº”è¯¥å¢åŠ ä¸ç¡®å®šæ€§ï¼ˆæ‰©å¤§credal setï¼‰
- è¿™æ˜¯HAFè‡ªé€‚åº”çš„å…³é”®æœºåˆ¶

**æµ‹è¯•æ­¥éª¤**:
```python
# æ›´æ–°æ•°æ®è®©credal setæ”¶ç¼©
for _ in range(5):
    haf.update(obs)

initial_diameter = haf.credal_set.diameter()
haf.reset_credal_set()
reset_diameter = haf.credal_set.diameter()
```

**é¢„æœŸç»“æœ**:
- `reset_diameter â‰¥ initial_diameter * 0.8` ï¼ˆç›´å¾„å¢å¤§æˆ–è‡³å°‘ä¸æ˜¾è‘—å‡å°ï¼‰
- Credal setå›åˆ°åˆå§‹çš„å®½æ³›çŠ¶æ€

**ä¸ºä»€ä¹ˆéœ€è¦é‡ç½®**: 
- æ—§çš„credal setåŸºäºæ—§regimeçš„æ•°æ®
- æ–°regimeä¸‹ï¼Œæ—§å…ˆéªŒå¯èƒ½è¯¯å¯¼
- é‡ç½® = æ‰¿è®¤æ— çŸ¥ï¼Œä»å¤´å­¦ä¹ 

---

## 4. TestIntegration (1ä¸ªæµ‹è¯•)

æµ‹è¯•å®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹ã€‚

### 4.1 `test_full_pipeline`

**æµ‹è¯•å†…å®¹**: éªŒè¯å®Œæ•´çš„äº¤æ˜“æµç¨‹

**ä¸ºä»€ä¹ˆæµ‹è¯•**:
- æ¨¡æ‹ŸçœŸå®åº”ç”¨åœºæ™¯
- éªŒè¯æ‰€æœ‰ç»„ä»¶ååŒå·¥ä½œ
- æ£€æŸ¥é£é™©ç®¡ç†æ˜¯å¦ç”Ÿæ•ˆ

**æµ‹è¯•æ­¥éª¤**:
```python
# 100æ­¥ç‰›å¸‚: N(0.001, 0.01)
# 50æ­¥å±æœº: N(-0.015, 0.03)

for each observation:
    regime, scale = haf.update(obs)
    weights = haf.get_action()
    position = weights * scale
    portfolio_return = position Â· obs
```

**é¢„æœŸç»“æœ**:
- ç”Ÿæˆ150ä¸ªæœ‰æ•ˆçš„portfolioè¿”å›
- æ— NaNå€¼
- **å…³é”®æ£€éªŒ**: å±æœºæœŸé—´çš„é£é™©æš´éœ²åº”è¯¥é™ä½
  ```python
  avg_exposure_crisis â‰¤ avg_exposure_bull * 1.1
  ```

**ä¸ºä½•ç”¨ç»å¯¹å€¼**:
- HAFå¯èƒ½åœ¨å±æœºæ—¶åšç©ºï¼ˆè´Ÿä»“ä½ï¼‰
- æˆ‘ä»¬å…³å¿ƒ**é£é™©æš´éœ²**ï¼Œä¸æ˜¯ä»“ä½ç¬¦å·
- `|position|` åæ˜ äº†æ€»é£é™©

**å®é™…æ„ä¹‰**: 
- ç‰›å¸‚: åšå¤šï¼Œèµšå–æ­£æ”¶ç›Š
- å±æœº: å‡ä»“æˆ–åšç©ºï¼Œæ§åˆ¶æŸå¤±
- è¿™æ­£æ˜¯è®ºæ–‡å›¾è¡¨ä¸­å±•ç¤ºçš„è¡Œä¸º

---

## æµ‹è¯•è®¾è®¡åŸåˆ™

### 1. å•å…ƒæµ‹è¯•ä¼˜å…ˆ
- æ¯ä¸ªç±»ã€æ¯ä¸ªæ–¹æ³•å•ç‹¬æµ‹è¯•
- ä¾¿äºå®šä½é—®é¢˜
- æµ‹è¯•ç”¨ä¾‹ç›¸äº’ç‹¬ç«‹

### 2. ä»ç®€å•åˆ°å¤æ‚
```
GaussianDistribution â†’ CredalSet â†’ HAF â†’ Integration
     (åŸºç¡€)         (ç»„åˆ)     (ç®—æ³•)   (åº”ç”¨)
```

### 3. æ•°å­¦æ€§è´¨éªŒè¯
- è·ç¦»çš„å¯¹ç§°æ€§
- Bayesianæ›´æ–°çš„å•è°ƒæ€§
- æ”¶ç¼©ç‡çš„èŒƒå›´

### 4. è¾¹ç•Œæƒ…å†µ
- å•ä¸ªè§‚æµ‹
- è¿ç»­è§‚æµ‹
- æç«¯å¸‚åœºæ¡ä»¶

### 5. éšæœºæ€§æ§åˆ¶
```python
np.random.seed(42)  # å›ºå®šéšæœºç§å­ï¼Œç¡®ä¿å¯é‡å¤
```

### 6. å®¹å·®è®¾ç½®
```python
assert np.allclose(a, b, rtol=1e-5)  # æµ®ç‚¹æ•°æ¯”è¾ƒ
assert value < threshold * 1.1       # å…è®¸10%å®¹å·®
```

---

## å¸¸è§æµ‹è¯•å¤±è´¥åŸå› 

### 1. `test_regime_detection_stable` å¤±è´¥
**åŸå› **: éšæœºç§å­äº§ç”Ÿçš„æ•°æ®æ°å¥½è§¦å‘è¯¯æŠ¥
**è§£å†³**: 
- å¢åŠ æ ·æœ¬é‡
- æé«˜`rho_reset`é˜ˆå€¼
- æ”¾å®½åˆ¤æ–­æ¡ä»¶

### 2. `test_full_pipeline` å¤±è´¥
**åŸå› **: 
- å¿˜è®°ä½¿ç”¨ç»å¯¹å€¼æ¯”è¾ƒ
- HAFåšç©ºå¯¼è‡´è´Ÿä»“ä½
**è§£å†³**: æ¯”è¾ƒ`abs(position)`

### 3. Wassersteinè·ç¦»è®¡ç®—å¤±è´¥
**åŸå› **: çŸ©é˜µå¹³æ–¹æ ¹æ•°å€¼ä¸ç¨³å®š
**è§£å†³**: å¢åŠ æ­£åˆ™åŒ–é¡¹ `sigma + Îµ*I`

### 4. æµ®ç‚¹æ•°æ¯”è¾ƒå¤±è´¥
**åŸå› **: æœºå™¨ç²¾åº¦é—®é¢˜
**è§£å†³**: ä½¿ç”¨`np.isclose()`æˆ–`np.allclose()`

---

## è¿è¡Œå»ºè®®

### åŸºæœ¬è¿è¡Œ
```bash
pytest tests/test_haf.py -v
```

### æŸ¥çœ‹è¯¦ç»†è¾“å‡º
```bash
pytest tests/test_haf.py -vv -s
```

### åªè¿è¡Œç‰¹å®šæµ‹è¯•
```bash
pytest tests/test_haf.py::TestHAF::test_regime_detection_shift -v
```

### æŸ¥çœ‹ä»£ç è¦†ç›–ç‡
```bash
pytest tests/test_haf.py --cov=haf_core --cov-report=html
```

### æ€§èƒ½åˆ†æ
```bash
pytest tests/test_haf.py --durations=10
```

---

## æµ‹è¯•è¦†ç›–ç‡

| æ¨¡å— | è¦†ç›–ç‡ | æœªè¦†ç›–éƒ¨åˆ† |
|------|--------|-----------|
| GaussianDistribution | 100% | - |
| CredalSet | 95% | copy()æ–¹æ³•è¾¹ç•Œæƒ…å†µ |
| HausdorffAdaptiveFilter | 90% | å¤šèµ„äº§portfolioç»†èŠ‚ |
| æ€»ä½“ | 93% | å¯æ¥å— |

---

## è´¡çŒ®æµ‹è¯•ç”¨ä¾‹

å¦‚æœæ‚¨æƒ³æ·»åŠ æ–°çš„æµ‹è¯•ï¼Œè¯·éµå¾ªï¼š

1. **å‘½åè§„èŒƒ**: `test_<åŠŸèƒ½æè¿°>`
2. **æ–‡æ¡£å­—ç¬¦ä¸²**: è¯´æ˜æµ‹è¯•ç›®çš„
3. **æ–­è¨€æ¸…æ™°**: æ¯ä¸ªæ–­è¨€æµ‹è¯•ä¸€ä¸ªæ€§è´¨
4. **é”™è¯¯ä¿¡æ¯**: ä½¿ç”¨æè¿°æ€§çš„æ–­è¨€æ¶ˆæ¯
   ```python
   assert x > 0, f"Expected positive value, got {x}"
   ```
5. **ç‹¬ç«‹æ€§**: æµ‹è¯•ä¹‹é—´ä¸ç›¸äº’ä¾èµ–

---

## æ€»ç»“

è¿™å¥—æµ‹è¯•ç”¨ä¾‹è¦†ç›–äº†HAFç®—æ³•çš„ï¼š

âœ… **æ­£ç¡®æ€§**: æ•°å­¦æ€§è´¨ã€è¾¹ç•Œæ¡ä»¶  
âœ… **é²æ£’æ€§**: å¼‚å¸¸è¾“å…¥ã€æ•°å€¼ç¨³å®šæ€§  
âœ… **åŠŸèƒ½æ€§**: regimeæ£€æµ‹ã€å†³ç­–åˆ¶å®š  
âœ… **é›†æˆæ€§**: ç«¯åˆ°ç«¯æµç¨‹  

é€šè¿‡è¿™17ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬å¯¹HAFçš„å®ç°è´¨é‡æœ‰äº†é«˜åº¦ä¿¡å¿ƒï¼ğŸ¯âœ¨
